{% extends "base.html" %}

{% block title %}{{ cls.name }}{% endblock %}

{% block content %}
<div class="class-view">
    <h2>{{ cls.name }}</h2>
    
    <div class="class-tabs">
        <button class="tab-btn active" data-tab="students">Students</button>
        <button class="tab-btn" data-tab="groups">Groups</button>
        <button class="tab-btn" data-tab="assignments">Assignments</button>
    </div>
    
    <div class="tab-content active" id="students-tab">
        <div class="section-header">
            <h3>Students</h3>
            <button class="btn btn-primary" onclick="showAddStudentModal()">Add Student</button>
        </div>
        
        {% if students %}
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr>
                        <td>
                            <a href="{{ url_for('view_student_code', class_id=cls.id, user_id=student.id) }}" class="student-link" title="Click to view student code">
                                {{ student.name }}
                            </a>
                        </td>
                        <td>{{ student.email }}</td>
                        <td>
                            <form method="POST" action="{{ url_for('delete_student', class_id=cls.id, user_id=student.id) }}" style="display:inline;">
                                <button type="submit" class="btn btn-danger btn-small" onclick="return confirm('Are you sure you want to remove this student?')">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="no-data">No students enrolled yet.</p>
        {% endif %}
    </div>
    
    <div class="tab-content" id="groups-tab">
        <div class="section-header">
            <h3>Groups</h3>
            <button class="btn btn-primary" onclick="showCreateGroupModal()">Create Group</button>
        </div>
        
        {% if groups %}
            <div class="groups-list">
                {% for group in groups %}
                <div class="group-item">
                    <div class="group-header">
                        <h4>{{ group.name }}</h4>
                        <form method="POST" action="{{ url_for('delete_group', class_id=cls.id, group_id=group.id) }}" style="display:inline;">
                            <button type="submit" class="btn btn-danger btn-small" onclick="return confirm('Are you sure you want to delete this group?')">Delete</button>
                        </form>
                    </div>
                    <ul class="group-members" id="group-{{ group.id }}-members"></ul>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="no-data">No groups created yet.</p>
        {% endif %}
    </div>
    
    <div class="tab-content" id="assignments-tab">
        <div class="section-header">
            <h3>Assignments</h3>
            <a href="{{ url_for('create_assignment', class_id=cls.id) }}" class="btn btn-primary">Create Assignment</a>
        </div>
        
        {% if assignments %}
            <div class="assignments-list">
                {% for assignment in assignments %}
                <div class="assignment-item">
                    <h4>{{ assignment.name }}</h4>
                    {% if assignment.due_date %}
                    <p>Due: {{ assignment.due_date.strftime('%B %d, %Y') }}</p>
                    {% endif %}
                    <div class="assignment-actions">
                        <a href="{{ url_for('manage_assignment', assignment_id=assignment.id) }}" class="btn btn-primary btn-small">Manage</a>
                        <a href="{{ url_for('review_feedback', assignment_id=assignment.id) }}" class="btn btn-secondary btn-small">Review Feedback</a>
                        {% if assignment.is_active %}
                            <span class="status-badge active">Active</span>
                        {% endif %}
                        {% if assignment.presenting_group_id %}
                            <span class="status-badge">Has Presenting Group</span>
                        {% endif %}
                        {% if assignment.results_released %}
                            <span class="status-badge released">Results Released</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="no-data">No assignments created yet.</p>
        {% endif %}
    </div>
</div>

<div id="addStudentModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAddStudentModal()">&times;</span>
        <h3>Add Student</h3>
        <form method="POST" action="{{ url_for('add_student', class_id=cls.id) }}">
            <div class="form-group">
                <label for="student_name">Name</label>
                <input type="text" id="student_name" name="name" required>
            </div>
            <div class="form-group">
                <label for="student_email">Email (@monmouth.edu)</label>
                <input type="email" id="student_email" name="email" required pattern=".*@monmouth\.edu$">
            </div>
            <div class="form-group">
                <label for="student_password">Temporary Password</label>
                <input type="text" id="student_password" name="password" required placeholder="e.g., TempPass123!">
            </div>
            <button type="submit" class="btn btn-primary">Add Student</button>
        </form>
    </div>
</div>

<div id="createGroupModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeCreateGroupModal()">&times;</span>
        <h3>Create Group</h3>
        <form method="POST" action="{{ url_for('create_group', class_id=cls.id) }}">
            <div class="form-group">
                <label for="group_name">Group Name</label>
                <input type="text" id="group_name" name="name" required>
            </div>
            <div class="form-group">
                <label>Select Students</label>
                <div class="checkbox-group">
                    {% for student in students %}
                    <label class="checkbox-label">
                        <input type="checkbox" name="student_ids" value="{{ student.id }}">
                        {{ student.name }}
                    </label>
                    {% endfor %}
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Create Group</button>
        </form>
    </div>
</div>

<script>
const groups = {{ groups | tojson }};
const classId = {{ cls.id }};

document.addEventListener('DOMContentLoaded', function() {
    groups.forEach(group => {
        fetch(`/api/group/${group.id}/members`)
            .then(r => r.json())
            .then(members => {
                const ul = document.getElementById(`group-${group.id}-members`);
                members.forEach(member => {
                    const li = document.createElement('li');
                    li.textContent = member.name;
                    ul.appendChild(li);
                });
            });
    });
    
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tabName = this.dataset.tab;
            
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            this.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        });
    });
});

function showAddStudentModal() {
    document.getElementById('addStudentModal').style.display = 'block';
}

function closeAddStudentModal() {
    document.getElementById('addStudentModal').style.display = 'none';
}

function showCreateGroupModal() {
    document.getElementById('createGroupModal').style.display = 'block';
}

function closeCreateGroupModal() {
    document.getElementById('createGroupModal').style.display = 'none';
}
</script>
{% endblock %}